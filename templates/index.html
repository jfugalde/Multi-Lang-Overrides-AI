<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BigTools Multilang AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/htmx.org@1.9.12"></script>
  <style>[x-cloak]{display:none}</style>
  <script>

    const perPage = 10;
    let currentPage = 1;
    let currentMode = 'generate';

    async function fetchJSON(url, opts={}){const r=await fetch(url,opts);if(!r.ok)throw new Error(await r.text());return r.json();}

    async function loadProducts(page=1){
      currentPage = page;
      const res = await fetchJSON(`/api/products?limit=${perPage}&page=${page}`);
      const tbody = document.getElementById('products-body');
      tbody.innerHTML='';
      res.forEach(p=>{
        tbody.insertAdjacentHTML('beforeend',`
          <tr class="border-t hover:bg-blue-50">
            <td class="p-2 text-center"><input type="checkbox" class="prod-checkbox" value="${p.id}"></td>
            <td class="p-2 font-mono">${p.id}</td>
            <td class="p-2">${p.name}</td>
            <td class="p-2">$${Number(p.price||0).toFixed(2)}</td>
          </tr>`)
      });
      document.getElementById('current-page').textContent = page;
    }
    function prevPage(){if(currentPage>1)loadProducts(currentPage-1)}
    function nextPage(){loadProducts(currentPage+1)}


    function openModal(html){
      const m=document.getElementById('modal');
      document.getElementById('modal-body').innerHTML=html;
      m.classList.remove('hidden');
    }
    function closeModal(){document.getElementById('modal').classList.add('hidden')}

    async function runAction(ev){
      ev.preventDefault();
      const ids=[...document.querySelectorAll('.prod-checkbox:checked')].map(e=>Number(e.value));
      if(ids.length===0)return alert('Select at least 1 product');

      if(currentMode==='generate'){
        const locales=[...document.querySelectorAll('input[name="locale"]:checked')].map(e=>e.value);
        openModal('<p class="text-sm text-gray-600">Generating overrides…</p>');
        try{
          const data=await fetchJSON('/api/generate-overrides',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ids,base_language:'en',target_locales:locales})});
          openModal(`<pre class='text-xs whitespace-pre-wrap'>${JSON.stringify(data,null,2)}</pre>`);
        }catch(e){openModal(`<p class='text-red-600'>${e.message}</p>`)}
      }

      if(currentMode==='view'){
        openModal('<p class="text-sm text-gray-600">Loading overrides…</p>');
        try{
          const data=await fetchJSON(`/api/products-with-overrides?ids=${ids.join(',')}`);
          const html=data.map(p=>{
            const oRows=p.overrides.map(o=>`<tr><td class='p-1 font-mono text-xs'>${o.locale}</td><td class='p-1'>${o.name}</td></tr>`).join('');
            return `<details class='mb-3 border rounded'><summary class='cursor-pointer p-2 bg-blue-100'>${p.name} (#${p.id})</summary><table>${oRows}</table></details>`;
          }).join('');
          openModal(html);
        }catch(e){openModal(`<p class='text-red-600'>${e.message}</p>`)}
      }

      if(currentMode==='edit'){
        // For simplicity, allow only one product at a time in edit mode
        if(ids.length!==1)return alert('Select exactly 1 product to edit');
        const pid=ids[0];
        openModal('<p class="text-sm text-gray-600">Fetching product…</p>');
        try{
          const locales=[...document.querySelectorAll('input[name="locale"]:checked')].map(e=>e.value);
          const data=await fetchJSON(`/api/products-with-overrides?ids=${pid}`);
          const prod=data[0];
          const localeForms=prod.overrides.map(o=>`<div class='mb-3'>
              <h4 class='font-semibold mb-1'>${o.locale.toUpperCase()}</h4>
              <input class='border p-1 w-full mb-1' value='${o.name.replace(/'/g,"&#039;")}' data-locale='${o.locale}' data-field='name'>
              <textarea class='border p-1 w-full text-xs' rows='3' data-locale='${o.locale}' data-field='description'>${o.description.replace(/'/g,"&#039;")}</textarea>
            </div>`).join('');
          const formHtml=`<h3 class='text-lg font-semibold mb-2'>Edit Product #${pid}</h3>${localeForms}<button onclick='saveEdits(${pid})' class='mt-4 px-4 py-2 bg-emerald-600 text-white rounded'>Save</button>`;
          openModal(formHtml);
        }catch(e){openModal(`<p class='text-red-600'>${e.message}</p>`)}
      }
    }

    async function saveEdits(pid){
      const inputs=[...document.querySelectorAll('#modal-body [data-locale]')];
      const payload={};
      inputs.forEach(el=>{
        const loc=el.dataset.locale;
        const field=el.dataset.field;
        payload[loc]=payload[loc]||{};payload[loc][field]=el.value;
      });
      openModal('<p class="text-sm text-gray-600">Saving…</p>');
      try{
        const data=await fetchJSON('/api/update-basic-info',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({product_id:pid,locales:payload})});
        openModal(`<pre class='text-xs'>${JSON.stringify(data,null,2)}</pre>`);
      }catch(e){openModal(`<p class='text-red-600'>${e.message}</p>`)}
    }

    function switchMode(mode){
      currentMode=mode;
      document.querySelectorAll('[data-tab]').forEach(btn=>btn.classList.toggle('bg-indigo-600',btn.dataset.tab===mode));
      document.getElementById('mode-title').textContent=(mode==='generate'?'Generate Overrides':mode==='view'?'View Overrides':'Edit Storefront Content');
      loadProducts(1);
    }

    window.onload=()=>{loadProducts(1);}
  </script>
</head>
<body class="bg-gradient-to-b from-blue-50 to-blue-100 min-h-screen py-8 px-4">
  <div class="max-w-6xl mx-auto bg-white p-8 rounded-2xl shadow-lg relative">
    <h1 class="text-4xl font-extrabold text-blue-800 mb-6">BigTools Multilang AI</h1>

    <!-- NAV -->
    <div class="flex gap-4 mb-6">
      <button data-tab="generate" onclick="switchMode('generate')" class="px-4 py-2 rounded-lg font-medium text-white bg-indigo-600">Generate Overrides</button>
      <button data-tab="view" onclick="switchMode('view')" class="px-4 py-2 rounded-lg font-medium text-gray-800 bg-gray-200">View Overrides</button>
      <button data-tab="edit" onclick="switchMode('edit')" class="px-4 py-2 rounded-lg font-medium text-gray-800 bg-gray-200">Edit Storefront</button>
    </div>

    <h2 id="mode-title" class="text-2xl font-semibold text-gray-700 mb-3">Generate Overrides</h2>

    <form onsubmit="runAction(event)">
      <div class="mb-4">
        <span class="font-semibold text-gray-700 mr-2">Locales:</span>
        {% for loc in ['es','de','fr'] %}
          <label class="mr-4 text-sm">
            <input type="checkbox" name="locale" value="{{loc}}" checked class="mr-1"> {{loc}}
          </label>
        {% endfor %}
      </div>

      <div class="overflow-x-auto rounded-lg shadow">
        <table class="w-full text-sm">
          <thead class="bg-blue-100 text-blue-900">
            <tr>
              <th class="p-2"></th>
              <th class="p-2 text-left">ID</th>
              <th class="p-2 text-left">Name</th>
              <th class="p-2 text-left">Price</th>
            </tr>
          </thead>
          <tbody id="products-body" class="bg-white"></tbody>
        </table>
      </div>

      <div class="flex justify-between items-center mt-6">
        <div>
          <button type="button" onclick="prevPage()" class="px-3 py-1 bg-blue-200 text-blue-800 rounded hover:bg-blue-300">&larr; Prev</button>
          <span id="current-page" class="px-3 font-bold text-blue-700">1</span>
          <button type="button" onclick="nextPage()" class="px-3 py-1 bg-blue-200 text-blue-800 rounded hover:bg-blue-300">Next &rarr;</button>
        </div>
        <button class="px-6 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 shadow-lg">Run Action</button>
      </div>
    </form>
  </div>

  <!-- MODAL -->
  <div id="modal" class="fixed inset-0 flex items-center justify-center bg-black/60 z-50 hidden" onclick="closeModal()">
    <div onclick="event.stopPropagation()" class="bg-white max-w-2xl w-full mx-4 p-6 rounded-xl shadow-xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold">Result</h3>
        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <div id="modal-body" class="text-sm max-h-[70vh] overflow-y-auto"></div>
    </div>
  </div>
</body>
</html>
